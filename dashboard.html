<!--
Arquivo: dashboard.html
Cole este arquivo INTEIRO, substituindo o seu dashboard.html atual.
ObservaÃ§Ã£o: NÃƒO inclui lÃ³gica de grÃ¡ficos aqui â€” isso fica em js/dashboard.js.
Este HTML sÃ³ garante: estrutura, IDs corretos, tabela oculta, botÃµes (sync/pdf/tabela), Ã¡reas dos grÃ¡ficos e insights.
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Agenda SISREG</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    /* Mantive APENAS o mÃ­nimo para a pÃ¡gina nÃ£o â€œquebrarâ€
       (o visual deve vir do theme.css) */
    body{ margin:0; font-family:'Inter',sans-serif; }
    #secTabela{ display:none; }
    .full-width{ grid-column: 1 / -1; }

    /* [AJUSTE] BotÃ£o "Ver Tabela" dentro do card Insights */
    #cardInsights .card-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    
    /* override do .card h3 (pra nÃ£o dar margem duplicada) */
    #cardInsights .card-head h3{
      margin: 0;
    }
    
    #cardInsights #btnToggleTabela{
      white-space: nowrap;
    }

  </style>
</head>

<body>

  <!-- HEADER -->
  <header class="dash-header">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="unit-info">
        <h1 id="txtUnidade">Carregando unidade...</h1>
        <p>Painel Gerencial de Escalas â€¢ <strong>SISREG Amazonas</strong></p>
      </div>
  
      <div class="header-btns">
        <button id="btnSincronizar" class="btn-main btn-sync">ğŸ”„ Sincronizar</button>
        <button id="btnExportarPDF" class="btn-main">ğŸ“„ Exportar PDF</button>
        <a href="escalas.html" style="text-decoration:none;">
          <button class="btn-main btn-new">â• Nova Escala</button>
        </a>
        <button id="btnLogout" class="btn-main btn-logout">Sair</button>
      </div>
    </div>
  </header>

  <!-- FILTRO (Fase 2/3 usam esse id) -->
  <section class="filter-section">
    <label for="filtroMes">Filtrar por MÃªs de VigÃªncia:</label>
    <select id="filtroMes">
      <option value="todos">Mostrar Todos</option>
      <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">MarÃ§o</option>
      <option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option>
      <option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option>
      <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
    </select>
  </section>

  <!-- ÃREA DO DASHBOARD (usada no PDF) -->
  <main class="container" id="dashboardArea">

    <!-- KPIs (IDs devem bater com dashboard.js) -->
    <section class="kpi-container">
      <div class="kpi-card">
        <h3>Total de Vagas</h3>
        <p id="kpiVagas">0</p>
      </div>

      <div class="kpi-card">
        <h3>% Vagas Retorno</h3>
        <p id="kpiRetorno">0%</p>
      </div>

      <div class="kpi-card">
        <h3>Profissionais</h3>
        <p id="kpiProfissionais">0</p>
      </div>

      <div class="kpi-card">
        <h3>Procs. Ãšnicos</h3>
        <p id="kpiProcedimentos">0</p>
      </div>

      <div class="kpi-card">
        <h3>Procedimento LÃ­der</h3>
        <p id="kpiLider" style="font-size:1rem;">-</p>
      </div>
    </section>

    <!-- GRID DE GRÃFICOS -->
    <section class="dashboard-grid">

      <div class="card">
        <h3>ğŸ”¥ Oferta por Dia e HorÃ¡rio</h3>
        <canvas id="chartHeatmap"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ¯ Funil de Oferta</h3>
        <canvas id="chartFunil"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ§¬ Perfil da Unidade</h3>
        <canvas id="chartRadar"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ«§ Profissionais por Impacto</h3>
        <canvas id="chartBolhas"></canvas>
      </div>

      <div class="card">
        <h3>ğŸŸ¡ DistribuiÃ§Ã£o de Vagas</h3>
        <canvas id="chartDonutOuter" style="position: absolute; top: 0; left: 0;"></canvas>
        <canvas id="chartDonutInner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 150px; height: 150px;"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ“ˆ EvoluÃ§Ã£o da VigÃªncia</h3>
        <canvas id="chartLinha"></canvas>
      </div>

      <div class="card full-width" id="cardInsights">
        <div class="card-head">
          <h3>ğŸ§  Insights AutomÃ¡ticos</h3>
          <button class="btn btn-toggle" id="btnToggleTabela">ğŸ“‹ Ver Tabela</button>
        </div>
        <ul id="listaInsights"></ul>
      </div>


      <!-- (Opcional) se seu JS da Fase 3 usar KPI de mÃ©dia, mantenha este id (nÃ£o quebra se nÃ£o usar) -->
      <span id="kpiMedia" style="display:none;"></span>

    </section>

    <!-- TABELA (OCULTA) â€” IDs precisam bater com dashboard.js -->
    <section id="secTabela" class="card full-width" style="margin-top:20px;">
      <h3>ğŸ“‹ Tabela Detalhada</h3>
      <div style="overflow:auto;">
        <table id="tabEscalas">
          <thead>
            <tr>
              <th>CPF</th>
              <th>Profissional</th>
              <th>CÃ³d. Proc.</th>
              <th>Procedimento</th>
              <th>Exames</th>
              <th>Dias</th>
              <th>InÃ­cio</th>
              <th>Fim</th>
              <th>Vagas</th>
              <th>Vig. InÃ­cio</th>
              <th>Vig. Fim</th>
            </tr>
          </thead>
          <tbody id="corpoTabela"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- FOOTER (dashboard.js preenche esse id) -->
  <footer id="footerCreditos"></footer>
  
  <!-- Seu JS principal -->
  <script src="js/dashboard.js"></script>

  <!-- Somente eventos â€œde telaâ€ (nÃ£o mexe na lÃ³gica do dashboard.js) -->
  <script>
    // Toggle da tabela
    document.getElementById("btnToggleTabela").onclick = () => {
      const sec = document.getElementById("secTabela");
      const aberto = sec.style.display === "block";
      sec.style.display = aberto ? "none" : "block";
      document.getElementById("btnToggleTabela").textContent = aberto ? "ğŸ“‹ Ver Tabela" : "ğŸ“‹ Ocultar Tabela";
    };

    // Exportar PDF do dashboardArea
    document.getElementById("btnExportarPDF").onclick = async () => {
      const area = document.getElementById("dashboardArea");

      // melhora captura: espera 1 frame
      await new Promise(r => requestAnimationFrame(r));

      const canvas = await html2canvas(area, { scale: 2, useCORS: true });
      const img = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageW = 210;
      const pageH = 297;

      const imgW = pageW;
      const imgH = (canvas.height * imgW) / canvas.width;

      let y = 10;
      if (imgH <= pageH - 20) {
        pdf.addImage(img, "PNG", 0, y, imgW, imgH);
      } else {
        // PaginaÃ§Ã£o simples se ficar maior que A4
        let remaining = imgH;
        let position = 10;
        pdf.addImage(img, "PNG", 0, position, imgW, imgH);
        remaining -= (pageH - 20);

        while (remaining > 0) {
          pdf.addPage();
          position = 10 - (imgH - remaining);
          pdf.addImage(img, "PNG", 0, position, imgW, imgH);
          remaining -= (pageH - 20);
        }
      }

      const unidade = (document.getElementById("txtUnidade").textContent || "UNIDADE").trim();
      pdf.save(`Dashboard_${unidade}.pdf`);
    };
  </script>

</body>
</html>
